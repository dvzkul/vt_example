name: vt_example
services:

  #Infrastructure
  mongo-db:
    image: mongo:6.0
    ports:
      - "${MONGO_PORT:-30001}:${MONGO_PORT:-30001}"
    volumes:
      - ${VT_EXAMPLE_DATA_LOCATION}/mongodb:/data/db
    networks:
      - vt_example_network
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DB_NAME:-vt_example_db}
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS}
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh mongo-db:${MONGO_PORT:-27017} --quiet
      interval: 10s
      retries: 5
      timeout: 5s

  mosquitto:
    image: eclipse-mosquitto
    ports:
      - "${MONGO_PORT:-30002}:1883"
      - "${MONGO_PORT_S:-30003}:9001"
    volumes:
      - ${VT_EXAMPLE_DATA_LOCATION}/mqtt/config:/mosquitto/config
      - ${VT_EXAMPLE_DATA_LOCATION}/mqtt/data:/mosquitto/data
      - ${VT_EXAMPLE_DATA_LOCATION}/mqtt/log:/mosquitto/log
    networks:
      - vt_example_network
    env_file:
      - .env
    restart: unless-stopped

  #Our Services
  vt_master:
    build:
      context: .
      dockerfile: Dockerfile.vt_master
    image: vt_example_vt_master:latest
    depends_on:
      - mongo-db
      - mosquitto
      - python-base
    networks:
      - vt_example_network
    env_file:
      - .env
    restart: unless-stopped

  vt_client_a_collector:
    build:
      context: .
      dockerfile: Dockerfile.client_a_collector
    depends_on:
      - mosquitto
      - python-base
    volumes:
      - ./example_files:/app/data
    networks:
      - vt_example_network
    environment:
      MQTT_BROKER_HOST: mosquitto
      INPUT_DIR: /app/data


  vt_client_b_collector:
    build:
      context: .
      dockerfile: Dockerfile.client_b_collector
    depends_on:
      - mosquitto
      - python-base
    volumes:
      - ./example_files:/app/data
    networks:
      - vt_example_network
    environment:
      MQTT_BROKER_HOST: mosquitto
      INPUT_DIR: /app/data

  #  Python Base Placeholder
  python-base:
    build:
      context: .
      dockerfile: Dockerfile.python_base
    container_name: vt_example_python_base
    volumes:
      - pip-cache:/tmp/pip-cache
    image: vt_example_python_base:latest

networks:
  vt_example_network:
    driver: bridge
volumes:
  pip-cache: